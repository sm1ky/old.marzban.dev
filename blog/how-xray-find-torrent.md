---
author: iambabyninja
date: 2024-01-18
title: Как мы находим BitTorrent трафик
---

## Как определяется BitTorrent 

Сегодня мы рассмотрим как Xray-core определяет BitTorrent трафик на уровне пакетов и заголовков.
В нашем арсенале имеется две функции:

### Функция `SniffBittorrent`

Эта функция предназначена для определения, является ли трафик BitTorrent-трафиком. Она анализирует начало пакета данных:

- **Проверка длины**: Если длина входного массива байтов `b` меньше 20, функция возвращает ошибку, что указывает на недостаточность данных для анализа.
- **Анализ заголовка**: Функция проверяет, начинаются ли данные с байта `19` (что соответствует длине строки "BitTorrent protocol"), за которым следует сама строка "BitTorrent protocol". Это стандартный заголовок для BitTorrent-соединений.
- **Результат**:
  - Если условия выполняются, функция возвращает объект `SniffHeader`, подтверждая, что это BitTorrent-трафик.
  - Если условия не выполняются, возвращается ошибка `errNotBittorrent`.

#### Пример
Допустим, у нас есть пакет данных `b`, и первые 20 байтов этого пакета выглядят так: `[19, 'B', 'i', 't', 'T', 'o', 'r', 'r', 'e', 'n', 't', ' ', 'p', 'r', 'o', 't', 'o', 'c', 'o', 'l']`. Функция `SniffBittorrent` идентифицирует это как BitTorrent-трафик.

### Функция `SniffUTP`

Давайте более подробно рассмотрим функцию `SniffUTP` из файла `bittorrent.go` в репозитории Xray-core, которая используется для определения, является ли трафик UTP-трафиком, потенциально связанным с BitTorrent.

### Разбор Функции `SniffUTP`

#### Цель Функции
Функция `SniffUTP` предназначена для анализа трафика UTP (Micro Transport Protocol), который часто используется для передачи данных в BitTorrent-сетях. 

#### Алгоритм Функции
1. **Проверка Длины Данных**: 
   - Первым шагом функция проверяет, достаточна ли длина входного массива байтов `b`. Если длина меньше 20 байтов, функция не может достоверно анализировать данные, и возвращает ошибку `common.ErrNoClue`.
   - 
2. **Создание Буфера**:
   - Функция создает буфер `buffer` из входного массива байтов `b` для удобства чтения данных.
   - 
3. **Чтение Типа и Версии**:
   - Считывается один байт, который содержит информацию о типе пакета и версии протокола UTP. Этот байт разбивается на две части: 4 бита для версии (`b[0] >> 4 & 0xF`) и 4 бита для типа (`b[0] & 0xF`). 
   - Если версия больше 4 или тип не равен 1, предполагается, что это не UTP-трафик, и возвращается ошибка `errNotBittorrent`.

4. **Чтение Расширения**:
   - Затем считывается ещё один байт, который указывает на наличие расширений. Если расширение не равно 0 или 1, считается, что это не UTP-трафик, и возвращается ошибка `errNotBittorrent`.

5. **Анализ Расширений**:
   - Если расширение присутствует, функция продолжает читать дополнительные байты, представляющие расширения, до тех пор, пока не найдет байт расширения, равный 0, что указывает на конец заголовка расширений.

6. **Чтение Временной Метки**:
   - После прохождения всех расширений функция читает 32-битное значение временной метки и сравнивает его с текущим временем. Если разница во времени превышает 24 часа, предполагается, что это не BitTorrent-трафик, и возвращается ошибка `errNotBittorrent`.

#### Результат Функции
- Если все проверки пройдены успешно, функция возвращает объект `SniffHeader`, указывающий на потенциальный BitTorrent-трафик через UTP.
- В противном случае возвращается соответствующая ошибка.
